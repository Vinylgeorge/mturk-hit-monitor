// ==UserScript==
// @name        MTurk Task ‚Üí Firestore + User Mapping (Fixed CSV Mapping, Auto-Remove 10m)
// @namespace   Violentmonkey Scripts
// @match       https://worker.mturk.com/projects/*/tasks/*
// @grant       none
// @version     2.2
// ==/UserScript==

(function () {
  'use strict';

  const s = document.createElement("script");
  s.type = "module";
  s.textContent = `
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, setDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyC57W83XkxdvM2aMQK8GIRYR2SJH1ORdfQ",
      authDomain: "mturk-tasks-72994.firebaseapp.com",
      projectId: "mturk-tasks-72994",
      storageBucket: "mturk-tasks-72994.firebasestorage.app",
      messagingSenderId: "305467873275",
      appId: "1:305467873275:web:7b96048865c5305df1dd5e"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Google Sheet for user mapping ---
    const SHEET_CSV =
      "https://docs.google.com/spreadsheets/d/1oyR6URA8qOmg6Zo90Df4w1h5lckOmjVC_9JrE-AXouM/export?format=csv&gid=0";

    const workerToUser = {};

    async function loadUserMap() {
      try {
        const res = await fetch(SHEET_CSV, { cache: "no-store" });
        const text = await res.text();
        const lines = text.split(/\\r?\\n/).filter(l => l.trim().length > 0);

        // --- detect separator (comma or semicolon)
        const sep = (lines[0].includes(";") && !lines[0].includes(",")) ? ";" : ",";

        const headers = lines[0].split(sep).map(h => h.trim().toLowerCase());
        const widIdx = headers.findIndex(h => h.replace(/\\s+/g, "") === "workerid");
        const userIdx = headers.findIndex(h => h.replace(/\\s+/g, "") === "user");

        if (widIdx === -1 || userIdx === -1) {
          console.warn("‚ö†Ô∏è 'workerid' or 'user' column not found in CSV header:", headers);
          return;
        }

        for (let i = 1; i < lines.length; i++) {
          const parts = lines[i].split(sep).map(v => v.trim());
          const wid = parts[widIdx]?.replace(/^\\uFEFF/, "").trim(); // remove BOM
          const usr = parts[userIdx]?.trim();
          if (/^A[A-Z0-9]{12,}$/.test(wid)) workerToUser[wid] = usr || "";
        }

        console.log("‚úÖ Loaded user map:", Object.keys(workerToUser).length, "entries");
      } catch (err) {
        console.error("‚ùå Failed to load user map:", err);
      }
    }

    // --- Helpers ---
    function getWorkerId() {
      const el = document.querySelector(".me-bar span.text-uppercase span");
      if (!el) return null;
      const txt = el.textContent.replace(/^Copied/i, "").trim();
      const match = txt.match(/A[A-Z0-9]{12,}/);
      return match ? match[0] : txt;
    }

    function parseReward() {
      let reward = 0.0;
      const label = Array.from(document.querySelectorAll(".detail-bar-label"))
        .find(el => el.textContent.includes("Reward"));
      if (label) {
        const valEl = label.nextElementSibling;
        if (valEl) {
          const match = valEl.innerText.match(/\\$([0-9.]+)/);
          if (match) reward = parseFloat(match[1]);
        }
      }
      return reward;
    }

    function collectTaskHit() {
      const assignmentId = new URLSearchParams(window.location.search).get("assignment_id");
      if (!assignmentId) return null;

      const workerId = getWorkerId();
      const user = workerToUser[workerId] || "Unknown";

      return {
        assignmentId,
        workerId,
        user,
        requester: document.querySelector(".detail-bar-value a[href*='/requesters/']")?.innerText || "",
        title: document.querySelector(".task-project-title")?.innerText || document.title,
        reward: parseReward(),
        acceptedAt: new Date().toISOString(),
        url: window.location.href,
        status: "active"
      };
    }

    async function postTask() {
      const hit = collectTaskHit();
      if (!hit) return;
      await setDoc(doc(db, "hits", hit.assignmentId), hit, { merge: true });
      console.log("‚úÖ Posted HIT:", hit.assignmentId, "User:", hit.user, "Reward:", hit.reward);

      // auto-remove after 10 minutes
      setTimeout(async () => {
        await deleteDoc(doc(db, "hits", hit.assignmentId));
        console.log("üóëÔ∏è Auto-removed after 10m:", hit.assignmentId);
      }, 10 * 60 * 1000);
    }

    // --- Initialize ---
    window.addEventListener("load", async () => {
      await loadUserMap();
      await postTask();
    });
  `;
  document.head.appendChild(s);
})();
