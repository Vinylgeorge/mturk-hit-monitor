<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MTurk Live Hits â€” Firestore (TTL)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--card:#fff;--muted:#6b7280;--border:#e6e9ef;--bg:#f7f8fa}
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#111;margin:0;padding:20px}
    .wrap{max-width:1100px;margin:0 auto}
    h1{margin:0 0 12px}
    .bar{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
    input,button{font:inherit;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    button{cursor:pointer}
    table{width:100%;border-collapse:separate;border-spacing:0;background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
    th,td{padding:10px 12px;text-align:left;border-bottom:1px solid #f0f2f6;vertical-align:top}
    th{background:#f9fafb;font-weight:600}
    tr:last-child td{border-bottom:none}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef6ff}
    .muted{color:var(--muted)}
    .right{margin-left:auto}
    .empty{padding:18px;color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap">
  <h1>MTurk Live Hits</h1>
  <div class="bar">
    <label>Worker ID:</label>
    <input id="wid" placeholder="A2XXXXXXXXXXXX" />
    <button id="connectBtn">Connect</button>
    <span class="muted right" id="status">Disconnected</span>
  </div>

  <table>
    <thead>
      <tr>
        <th>Assignment</th>
        <th>Requester</th>
        <th>Title</th>
        <th>Reward</th>
        <th>Created</th>
        <th>TTL Left</th>
      </tr>
    </thead>
    <tbody id="rows"><tr><td colspan="6" class="empty">No data yet</td></tr></tbody>
  </table>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // âœ… Corrected config (apiKey & storageBucket)
  const firebaseConfig = {
    apiKey: "AIzaSyC57W83XkxdvM2aMQK8GIRYR2SJH1ORdfQ",
    authDomain: "mturk-tasks-72994.firebaseapp.com",
    projectId: "mturk-tasks-72994",
    storageBucket: "mturk-tasks-72994.appspot.com",
    messagingSenderId: "305467873275",
    appId: "1:305467873275:web:7b96048865c5305df1dd5e"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  const rows = document.getElementById('rows');
  const statusEl = document.getElementById('status');
  const widInput = document.getElementById('wid');
  const connectBtn = document.getElementById('connectBtn');

  // support ?worker=A2XXXX...
  const urlWid = new URL(location.href).searchParams.get('worker');
  if (urlWid) widInput.value = urlWid;

  let unsub = null;
  let cache = [];

  const toMillis = (ts) => {
    if (!ts) return 0;
    if (typeof ts === 'number') return ts;
    if (typeof ts === 'object' && typeof ts.toMillis === 'function') return ts.toMillis();
    const t = Date.parse(ts); return Number.isNaN(t) ? 0 : t;
  };

  function render() {
    const now = Date.now();
    if (!cache.length) {
      rows.innerHTML = '<tr><td colspan="6" class="empty">No data yet</td></tr>';
      return;
    }
    rows.innerHTML = cache.map(h => {
      const createdMs = toMillis(h.createdAt);
      const expiresMs = toMillis(h.expiresAt);
      const ttlMs = Math.max(0, (expiresMs || 0) - now);
      const ttlSec = Math.ceil(ttlMs / 1000);
      const m = Math.floor(ttlSec/60), s = ttlSec % 60;
      return `
        <tr>
          <td><span class="pill">${h.assignmentId}</span></td>
          <td>${h.requester || ""}</td>
          <td>${h.title || ""}</td>
          <td>$${Number(h.reward||0).toFixed(2)}</td>
          <td>${createdMs ? new Date(createdMs).toLocaleTimeString() : "-"}</td>
          <td>${ttlSec ? `${m}m ${String(s).padStart(2,"0")}s` : "expired"}</td>
        </tr>`;
    }).join('');
  }

  function startTicker(){ render(); requestAnimationFrame(startTicker); }

  function connect(workerId) {
    if (unsub) { unsub(); unsub = null; }
    cache = [];
    rows.innerHTML = '<tr><td colspan="6" class="empty">Loadingâ€¦</td></tr>';
    statusEl.textContent = 'Connectingâ€¦';

    const hitsRef = collection(db, 'hits');

    // ðŸ” NO orderBy here â†’ avoids composite-index requirement
    const qref = query(hitsRef, where('workerId','==', workerId));

    unsub = onSnapshot(qref, (snap) => {
      cache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      // sort client-side by createdAt desc
      cache.sort((a,b) => toMillis(b.createdAt) - toMillis(a.createdAt));
      statusEl.textContent = `Live: ${cache.length} item(s)`;
      render();
    }, (err) => {
      console.error(err);
      statusEl.textContent = 'Listener error (see console)';
    });
  }

  connectBtn.addEventListener('click', () => {
    const wid = widInput.value.trim();
    if (!/^A[A-Z0-9]{12,}$/.test(wid)) return alert('Enter valid Worker ID (e.g., A2XXXXXXXXXXX)');
    connect(wid);
  });

  if (widInput.value) connect(widInput.value);
  startTicker();
</script>
</body>
</html>
