<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MTurk Viewer — Flexible CSV</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Inter,Arial,Helvetica,sans-serif;margin:16px;background:#f7f8fa;color:#111}
    .wrap{max-width:1100px;margin:0 auto}
    input.text{padding:8px;border-radius:6px;border:1px solid #ddd;width:520px}
    button{padding:8px 12px;background:#0f62fe;color:#fff;border:0;border-radius:8px;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    thead th{background:#fff;padding:8px;border-bottom:1px solid #e6e6e6;text-align:left}
    td{padding:8px;border-bottom:1px solid #eee}
    a.link{color:#0f62fe;text-decoration:none}
    .small{font-size:13px;color:#555}
    .notice{margin-top:8px;color:#333}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>MTurk Viewer — Flexible CSV</h2>

    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <input id="sheetUrl" class="text" placeholder="Paste CSV export URL (or leave empty to paste CSV text below)" />
      <button id="loadBtn">Load</button>
    </div>

    <textarea id="pasteCsv" style="width:100%;height:120px;margin-top:10px" placeholder="(optional) paste CSV text here instead of a URL"></textarea>

    <div class="notice small">
      Required headers (any case, spaces allowed): <strong>workerId, host, username, encryptedPassword</strong>.
    </div>

    <div id="status" class="small" style="margin-top:8px"></div>
    <div id="tableContainer"></div>
  </div>

<script>
(function(){
  const statusEl = document.getElementById('status');
  const tableContainer = document.getElementById('tableContainer');
  const sheetUrlEl = document.getElementById('sheetUrl');
  const pasteCsvEl = document.getElementById('pasteCsv');
  const loadBtn = document.getElementById('loadBtn');

  // tolerant CSV parser
  function parseCsvText(txt){
    // detect delimiter
    let delimiter = txt.includes(';') && !txt.includes(',') ? ';' : ',';
    const rows = txt.split(/\r?\n/).map(r => r.trim()).filter(r => r.length>0);
    if (rows.length === 0) return { header: [], data: [] };

    // normalize headers
    let headerLine = rows[0].replace(/^\uFEFF/, ''); // strip BOM
    const header = headerLine.split(delimiter).map(h =>
      h.trim().toLowerCase().replace(/\s+/g,'') // remove spaces
    );

    const data = [];
    for (let i=1;i<rows.length;i++){
      const cols = rows[i].split(delimiter).map(c => c.trim());
      const obj = {};
      for (let j=0;j<header.length;j++){
        const key = header[j];
        if (!obj[key]) obj[key] = cols[j] || '';
      }
      data.push(obj);
    }
    return { header, data };
  }

  function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  function escapeAttr(s){ return String(s||'').replaceAll('"','&quot;'); }

  function renderTable(rows){
    if (!rows || rows.length===0) { tableContainer.innerHTML = '<div class="small">No rows</div>'; return; }
    let html = '<table><thead><tr><th>Worker ID</th><th>Host</th><th>Username</th><th>Encrypted</th></tr></thead><tbody>';
    rows.forEach(r => {
      const wid = r.workerid || r['workerId'] || '';
      const host = r.host || '';
      const user = r.username || r.user || '';
      const encPwd = r.encryptedpassword || '';
      html += `<tr>
        <td>${escapeHtml(wid)}</td>
        <td>${escapeHtml(host)}</td>
        <td>${escapeHtml(user)}</td>
        <td class="small">${escapeHtml(encPwd.slice(0,20))}...</td>
      </tr>`;
    });
    html += '</tbody></table>';
    tableContainer.innerHTML = html;
  }

  loadBtn.addEventListener('click', async ()=> {
    const url = sheetUrlEl.value.trim();
    const pasted = pasteCsvEl.value.trim();
    try {
      statusEl.textContent = 'Loading...';
      let csvText = '';
      if (pasted) {
        csvText = pasted;
      } else if (url) {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error('Failed to fetch CSV: ' + res.status);
        csvText = await res.text();
      } else {
        throw new Error('Provide CSV text or a CSV export URL');
      }

      const parsed = parseCsvText(csvText);
      if (!parsed.data.length) throw new Error('No rows found');

      // validate required fields exist
      const first = parsed.data[0];
      if (!(first.workerid || first.workerId)) throw new Error('Missing workerId');
      if (!first.host) throw new Error('Missing host');
      if (!(first.username || first.user)) throw new Error('Missing username');
      if (!first.encryptedpassword) throw new Error('Missing encryptedPassword');

      renderTable(parsed.data);
      statusEl.textContent = 'Loaded ' + parsed.data.length + ' row(s).';
    } catch (err) {
      statusEl.textContent = 'Error: ' + err.message;
      tableContainer.innerHTML = '';
      console.error(err);
    }
  });
})();
</script>
</body>
</html>
