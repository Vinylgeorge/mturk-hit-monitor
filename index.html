<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MTurk Viewer — WorkerID → RDP</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Inter,Arial,Helvetica,sans-serif;margin:16px;background:#f7f8fa;color:#111}
    .wrap{max-width:1100px;margin:0 auto}
    input.text{padding:8px;border-radius:6px;border:1px solid #ddd;width:520px}
    button{padding:8px 12px;background:#0f62fe;color:#fff;border:0;border-radius:8px;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    thead th{background:#fff;padding:8px;border-bottom:1px solid #e6e6e6;text-align:left}
    td{padding:8px;border-bottom:1px solid #eee}
    a.link{color:#0f62fe;text-decoration:none}
    .small{font-size:13px;color:#555}
    .notice{margin-top:8px;color:#333}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>MTurk Viewer — WorkerID → RDP</h2>

    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <input id="sheetUrl" class="text" placeholder="Paste CSV export URL (or leave empty to paste CSV text below)" />
      <button id="loadBtn">Load</button>
      <input id="passphrase" class="text" type="password" placeholder="Passphrase (for .bat)" style="width:240px">
      <button id="setPass">Set</button>
      <button id="clearPass">Clear</button>
    </div>

    <textarea id="pasteCsv" style="width:100%;height:120px;margin-top:10px" placeholder="(optional) paste CSV text here"></textarea>

    <div class="notice small">
      CSV must include: <strong>workerId, host, username, encryptedPassword</strong> (any case/spaces/semicolon ok).
    </div>

    <div id="status" class="small" style="margin-top:8px"></div>
    <div id="tableContainer"></div>
  </div>

<script>
(async function(){
  const PBKDF2_ITER=200000;const enc=new TextEncoder(),dec=new TextDecoder();let cachedPassphrase=null;
  function b642ab(b64){const binary=atob(b64);const bytes=new Uint8Array(binary.length);for(let i=0;i<binary.length;i++)bytes[i]=binary.charCodeAt(i);return bytes.buffer;}
  async function deriveKey(pass,salt){const base=await crypto.subtle.importKey('raw',enc.encode(pass),'PBKDF2',false,['deriveKey']);return await crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:PBKDF2_ITER,hash:'SHA-256'},base,{name:'AES-GCM',length:256},false,['decrypt']);}
  async function decryptCiphertext(ciph,pass){const [s,i,c]=ciph.split(':');const salt=new Uint8Array(b642ab(s));const iv=new Uint8Array(b642ab(i));const ct=b642ab(c);const key=await deriveKey(pass,salt.buffer);const pt=await crypto.subtle.decrypt({name:'AES-GCM',iv},key,ct);return dec.decode(pt);}

  function parseCsvText(txt){
    let delimiter=txt.includes(';')&&!txt.includes(',')?';':',';const rows=txt.split(/\r?\n/).map(r=>r.trim()).filter(r=>r.length>0);
    if(!rows.length) return {header:[],data:[]};let headerLine=rows[0].replace(/^\uFEFF/,'');
    const header=headerLine.split(delimiter).map(h=>h.trim().toLowerCase().replace(/\s+/g,''));
    const data=[];for(let i=1;i<rows.length;i++){const cols=rows[i].split(delimiter).map(c=>c.trim());const obj={};for(let j=0;j<header.length;j++){obj[header[j]]=cols[j]||'';}data.push(obj);}return {header,data};
  }

  function buildRdpContent(host,user){
    return `full address:s:${host}\r\nusername:s:${user}\r\nprompt for credentials:i:1\r\nredirectclipboard:i:1\r\nauthentication level:i:2`;
  }

  function buildBat(host,user,password,rdpFile){
    return `@echo off\r\ncmdkey /generic:TERMSRV/${host} /user:${user} /pass:${password}\r\nstart "" mstsc "${rdpFile}"\r\nREM cmdkey /delete:TERMSRV/${host}`;
  }

  function makeBlobUrl(content,type){return URL.createObjectURL(new Blob([content],{type}));}
  function escapeHtml(s){return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');}

  const sheetUrlEl=document.getElementById('sheetUrl'),pasteCsvEl=document.getElementById('pasteCsv'),loadBtn=document.getElementById('loadBtn');
  const statusEl=document.getElementById('status'),tableContainer=document.getElementById('tableContainer');
  const passInput=document.getElementById('passphrase'),setPassBtn=document.getElementById('setPass'),clearPassBtn=document.getElementById('clearPass');

  setPassBtn.onclick=()=>{if(passInput.value){cachedPassphrase=passInput.value;statusEl.textContent='Passphrase set.';}};
  clearPassBtn.onclick=()=>{cachedPassphrase=null;passInput.value='';statusEl.textContent='Passphrase cleared.';};

  loadBtn.onclick=async()=>{
    try{
      statusEl.textContent='Loading...';
      let csvText=pasteCsvEl.value.trim();
      if(!csvText&&sheetUrlEl.value){const res=await fetch(sheetUrlEl.value,{cache:'no-store'});csvText=await res.text();}
      const parsed=parseCsvText(csvText);
      if(!parsed.data.length) throw new Error('No rows found');
      renderTable(parsed.data);
      statusEl.textContent=`Loaded ${parsed.data.length} row(s).`;
    }catch(e){statusEl.textContent='Error: '+e.message;tableContainer.innerHTML='';}
  };

  function renderTable(rows){
    let html='<table><thead><tr><th>Worker</th><th>Host</th><th>User</th><th>.bat</th></tr></thead><tbody>';
    rows.forEach(r=>{
      const wid=r.workerid||'';const host=r.host||'';const user=r.username||r.user||'';const encPwd=r.encryptedpassword||'';
      const rdpBlob=makeBlobUrl(buildRdpContent(host,user),'application/rdp');const rdpName=`worker_${wid}.rdp`;
      html+=`<tr data-row='${encodeURIComponent(JSON.stringify({wid,host,user,encPwd}))}'>
        <td><a href="${rdpBlob}" download="${rdpName}">${escapeHtml(wid)}</a></td>
        <td>${escapeHtml(host)}</td><td>${escapeHtml(user)}</td>
        <td><a href="#" class="make-bat">.bat</a></td></tr>`;
    });
    html+='</tbody></table>';tableContainer.innerHTML=html;
    tableContainer.querySelectorAll('.make-bat').forEach(a=>a.onclick=async(ev)=>{
      ev.preventDefault();const row=JSON.parse(decodeURIComponent(ev.target.closest('tr').dataset.row));
      let pass=cachedPassphrase||prompt('Enter passphrase:');if(!pass) return;
      try{const plain=await decryptCiphertext(row.encPwd,pass);cachedPassphrase=pass;
        const batContent=buildBat(row.host,row.user,plain,`worker_${row.wid}.rdp`);
        const url=makeBlobUrl(batContent,'application/x-bat');const dl=document.createElement('a');dl.href=url;dl.download=`open_${row.wid}.bat`;dl.click();
      }catch(e){alert('Decrypt failed: '+e.message);cachedPassphrase=null;}
    });
  }
})();
</script>
</body>
</html>
